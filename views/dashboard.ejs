<!-- views/dashboard.ejs-->
<%- include('partials/header') %>

<h1 class="mb-4">Dashboard</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">My Goals</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                    Add Goal
                </button>
            </div>
            <div class="card-body">
                <% if(typeof goals !== 'undefined' && goals.length > 0) { %>
                    <%
                        // Filter goals by deadlines
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        // Get 3 days in the future date
                        const threeDaysFromNow = new Date(today);
                        threeDaysFromNow.setDate(today.getDate() + 3);

                        // Separate goals into categories
                        const expiredGoals = [];
                        const urgentGoals = [];
                        const normalGoals = [];
                        const noDeadlineGoals = [];
                        const completedGoals = [];

                        goals.forEach(goal => {
                            // Handle completed goals separately
                            if (goal.status === 'Completed') {
                                completedGoals.push(goal);
                                return;
                            }

                            if (!goal.deadline) {
                                noDeadlineGoals.push(goal);
                            } else {
                                const deadlineDate = new Date(goal.deadline);
                                deadlineDate.setHours(0, 0, 0, 0);

                                if (deadlineDate < today) {
                                    expiredGoals.push(goal);
                                } else if (deadlineDate <= threeDaysFromNow) {
                                    urgentGoals.push(goal);
                                } else {
                                    normalGoals.push(goal);
                                }
                            }
                        });

                        // Sort each category
                        expiredGoals.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                        urgentGoals.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                        normalGoals.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                        noDeadlineGoals.sort((a, b) => a.priority === 'High' ? -1 : b.priority === 'High' ? 1 : 0);
                    %>

                    <!-- Urgent goals (due within 3 days) -->
                    <% if (urgentGoals.length > 0) { %>
                        <div class="alert alert-warning mb-3">
                            <h5 class="alert-heading">⚠️ Goals Due Soon</h5>
                            <p>These goals are due within the next 3 days and require your attention.</p>
                        </div>

                        <table class="table table-striped table-bordered mb-4">
                            <thead class="table-warning">
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Est. Time</th>
                                <th>Deadline</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% urgentGoals.forEach(goal => { %>
                                <tr>
                                    <td><%= goal.title %></td>
                                    <td><%= goal.category || 'N/A' %></td>
                                    <td>
                                        <span class="badge <%= goal.priority === 'High' ? 'bg-danger' : goal.priority === 'Medium' ? 'bg-warning' : 'bg-info' %>">
                                          <%= goal.priority %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                          <%= goal.status %>
                                        </span>
                                    </td>
                                    <td><%= goal.estimated_pomodoros || 1 %> × 25min</td>
                                    <td class="text-danger fw-bold">
                                        <%= new Date(goal.deadline).toLocaleDateString() %>
                                        <%
                                            const deadlineDate = new Date(goal.deadline);
                                            const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                                            const dayText = daysUntil === 1 ? 'day' : 'days';
                                        %>
                                        (<%= daysUntil %> <%= dayText %> left)
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info edit-goal"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-description="<%= goal.description || '' %>"
                                                    data-category="<%= goal.category || '' %>"
                                                    data-priority="<%= goal.priority %>"
                                                    data-status="<%= goal.status %>"
                                                    data-deadline="<%= goal.deadline ? goal.deadline : '' %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Edit
                                            </button>
                                            <button class="btn btn-danger delete-goal" data-id="<%= goal.id %>">
                                                Delete
                                            </button>
                                            <button class="btn btn-success start-timer-btn"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Start Timer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                            </tbody>
                        </table>
                    <% } %>

                    <!-- Expired goals -->
                    <% if (expiredGoals.length > 0) { %>
                        <div class="alert alert-danger mb-3">
                            <h5 class="alert-heading">❗ Overdue Goals</h5>
                            <p>These goals have passed their deadlines and need immediate attention.</p>
                        </div>

                        <table class="table table-striped table-bordered mb-4">
                            <thead class="table-danger">
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Est. Time</th>
                                <th>Deadline</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% expiredGoals.forEach(goal => { %>
                                <tr>
                                    <td><%= goal.title %></td>
                                    <td><%= goal.category || 'N/A' %></td>
                                    <td>
                                        <span class="badge <%= goal.priority === 'High' ? 'bg-danger' : goal.priority === 'Medium' ? 'bg-warning' : 'bg-info' %>">
                                          <%= goal.priority %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                          <%= goal.status %>
                                        </span>
                                    </td>
                                    <td><%= goal.estimated_pomodoros || 1 %> × 25min</td>
                                    <td class="text-danger fw-bold">
                                        <%= new Date(goal.deadline).toLocaleDateString() %>
                                        <span class="badge bg-danger">Overdue!</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info edit-goal"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-description="<%= goal.description || '' %>"
                                                    data-category="<%= goal.category || '' %>"
                                                    data-priority="<%= goal.priority %>"
                                                    data-status="<%= goal.status %>"
                                                    data-deadline="<%= goal.deadline ? goal.deadline : '' %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Edit
                                            </button>
                                            <button class="btn btn-danger delete-goal" data-id="<%= goal.id %>">
                                                Delete
                                            </button>
                                            <button class="btn btn-success start-timer-btn"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Start Timer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                            </tbody>
                        </table>
                    <% } %>

                    <!-- Regular goals with deadlines -->
                    <% if (normalGoals.length > 0) { %>
                        <h5>Upcoming Goals</h5>
                        <table class="table table-striped table-bordered mb-4">
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Est. Time</th>
                                <th>Deadline</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% normalGoals.forEach(goal => { %>
                                <tr>
                                    <td><%= goal.title %></td>
                                    <td><%= goal.category || 'N/A' %></td>
                                    <td>
                                        <span class="badge <%= goal.priority === 'High' ? 'bg-danger' : goal.priority === 'Medium' ? 'bg-warning' : 'bg-info' %>">
                                          <%= goal.priority %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                          <%= goal.status %>
                                        </span>
                                    </td>
                                    <td><%= goal.estimated_pomodoros || 1 %> × 25min</td>
                                    <td><%= new Date(goal.deadline).toLocaleDateString() %></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info edit-goal"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-description="<%= goal.description || '' %>"
                                                    data-category="<%= goal.category || '' %>"
                                                    data-priority="<%= goal.priority %>"
                                                    data-status="<%= goal.status %>"
                                                    data-deadline="<%= goal.deadline ? goal.deadline : '' %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Edit
                                            </button>
                                            <button class="btn btn-danger delete-goal" data-id="<%= goal.id %>">
                                                Delete
                                            </button>
                                            <button class="btn btn-success start-timer-btn"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Start Timer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                            </tbody>
                        </table>
                    <% } %>

                    <!-- Goals without deadlines -->
                    <% if (noDeadlineGoals.length > 0) { %>
                        <h5>Goals Without Deadlines</h5>
                        <table class="table table-striped table-bordered mb-4">
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Est. Time</th>
                                <th>Deadline</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% noDeadlineGoals.forEach(goal => { %>
                                <tr>
                                    <td><%= goal.title %></td>
                                    <td><%= goal.category || 'N/A' %></td>
                                    <td>
                                        <span class="badge <%= goal.priority === 'High' ? 'bg-danger' : goal.priority === 'Medium' ? 'bg-warning' : 'bg-info' %>">
                                          <%= goal.priority %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                          <%= goal.status %>
                                        </span>
                                    </td>
                                    <td><%= goal.estimated_pomodoros || 1 %> × 25min</td>
                                    <td>No deadline</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info edit-goal"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-description="<%= goal.description || '' %>"
                                                    data-category="<%= goal.category || '' %>"
                                                    data-priority="<%= goal.priority %>"
                                                    data-status="<%= goal.status %>"
                                                    data-deadline="<%= goal.deadline ? goal.deadline : '' %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Edit
                                            </button>
                                            <button class="btn btn-danger delete-goal" data-id="<%= goal.id %>">
                                                Delete
                                            </button>
                                            <button class="btn btn-success start-timer-btn"
                                                    data-id="<%= goal.id %>"
                                                    data-title="<%= goal.title %>"
                                                    data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                Start Timer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                            </tbody>
                        </table>
                    <% } %>

                    <!-- Completed goals at the bottom -->
                    <% if (completedGoals.length > 0) { %>
                        <h5>Completed Goals</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-success">
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Est. Time</th>
                                    <th>Deadline</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <% completedGoals.forEach(goal => { %>
                                    <tr>
                                        <td><%= goal.title %></td>
                                        <td><%= goal.category || 'N/A' %></td>
                                        <td>
                                            <span class="badge <%= goal.priority === 'High' ? 'bg-danger' : goal.priority === 'Medium' ? 'bg-warning' : 'bg-info' %>">
                                              <%= goal.priority %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">Completed</span>
                                        </td>
                                        <td><%= goal.estimated_pomodoros || 1 %> × 25min</td>
                                        <td><%= goal.deadline ? new Date(goal.deadline).toLocaleDateString() : 'No deadline' %></td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-info edit-goal"
                                                        data-id="<%= goal.id %>"
                                                        data-title="<%= goal.title %>"
                                                        data-description="<%= goal.description || '' %>"
                                                        data-category="<%= goal.category || '' %>"
                                                        data-priority="<%= goal.priority %>"
                                                        data-status="<%= goal.status %>"
                                                        data-deadline="<%= goal.deadline ? goal.deadline : '' %>"
                                                        data-estimated-pomodoros="<%= goal.estimated_pomodoros || 1 %>">
                                                    Edit
                                                </button>
                                                <button class="btn btn-danger delete-goal" data-id="<%= goal.id %>">
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>

                <% } else { %>
                    <p>You have no goals yet. Click the "Add Goal" button to get started.</p>
                <% } %>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Goal Status</h5>
            </div>
            <div class="card-body">
                <canvas id="goalStatusChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Focus Time</h5>
            </div>
            <div class="card-body">
                <p>Start a Pomodoro session to track your focus time.</p>
                <a href="/timer" class="btn btn-primary">Go to Timer</a>
            </div>
        </div>
    </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm" action="/goals" method="POST">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-control" id="category" name="category">
                            <option value="">-- Select a category --</option>
                            <option value="Work">Work</option>
                            <option value="Study">Study</option>
                            <option value="Personal">Personal</option>
                            <option value="Health">Health</option>
                            <option value="Finance">Finance</option>
                            <option value="Project">Project</option>
                            <option value="Hobby">Hobby</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-control" id="priority" name="priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Deadline (optional)</label>
                        <input type="date" class="form-control" id="deadline" name="deadline">
                    </div>
                    <div class="mb-3">
                        <label for="estimated_pomodoros" class="form-label">Estimated Time (in 25-min Pomodoros)</label>
                        <select class="form-control" id="estimated_pomodoros" name="estimated_pomodoros">
                            <option value="1">1 Pomodoro (25 min)</option>
                            <option value="2">2 Pomodoros (50 min)</option>
                            <option value="3">3 Pomodoros (1h 15m)</option>
                            <option value="4">4 Pomodoros (1h 40m)</option>
                            <option value="6">6 Pomodoros (2h 30m)</option>
                            <option value="8">8 Pomodoros (3h 20m)</option>
                            <option value="10">10 Pomodoros (4h 10m)</option>
                            <option value="12">12 Pomodoros (5h)</option>
                        </select>
                        <div class="form-text">Estimate how many 25-minute sessions this goal will take to complete</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Goal</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm" method="POST">
                    <input type="hidden" id="edit-goal-id" name="id">
                    <div class="mb-3">
                        <label for="edit-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="edit-title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-category" class="form-label">Category</label>
                        <select class="form-control" id="edit-category" name="category">
                            <option value="">-- Select a category --</option>
                            <option value="Work">Work</option>
                            <option value="Study">Study</option>
                            <option value="Personal">Personal</option>
                            <option value="Health">Health</option>
                            <option value="Finance">Finance</option>
                            <option value="Project">Project</option>
                            <option value="Hobby">Hobby</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-priority" class="form-label">Priority</label>
                        <select class="form-control" id="edit-priority" name="priority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-status" class="form-label">Status</label>
                        <select class="form-control" id="edit-status" name="status">
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-deadline" class="form-label">Deadline (optional)</label>
                        <input type="date" class="form-control" id="edit-deadline" name="deadline">
                    </div>
                    <div class="mb-3">
                        <label for="edit-estimated_pomodoros" class="form-label">Estimated Time (in 25-min Pomodoros)</label>
                        <select class="form-control" id="edit-estimated_pomodoros" name="estimated_pomodoros">
                            <option value="1">1 Pomodoro (25 min)</option>
                            <option value="2">2 Pomodoros (50 min)</option>
                            <option value="3">3 Pomodoros (1h 15m)</option>
                            <option value="4">4 Pomodoros (1h 40m)</option>
                            <option value="6">6 Pomodoros (2h 30m)</option>
                            <option value="8">8 Pomodoros (3h 20m)</option>
                            <option value="10">10 Pomodoros (4h 10m)</option>
                            <option value="12">12 Pomodoros (5h)</option>
                        </select>
                        <div class="form-text">Estimate how many 25-minute sessions this goal will take to complete</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Goal</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Goal Modal -->
<div class="modal fade" id="deleteGoalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this goal? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteGoalForm" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Start Timer Modal -->
<div class="modal fade" id="startTimerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Timer for <span id="timer-goal-title"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="startTimerForm" action="/timer" method="GET">
                    <input type="hidden" id="timer-goal-id" name="goalId">
                    <input type="hidden" name="autoStart" value="true">
                    <input type="hidden" id="timer-estimated-pomodoros" name="estimatedPomodoros" value="1">

                    <div class="mb-3">
                        <label for="timer-duration" class="form-label">Timer Duration (minutes)</label>
                        <select class="form-control" id="timer-duration" name="duration">
                            <option value="15">15 minutes</option>
                            <option value="25" selected>25 minutes (Standard Pomodoro)</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="90">90 minutes</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="break-duration" class="form-label">Break Duration (minutes)</label>
                        <select class="form-control" id="break-duration" name="breakDuration">
                            <option value="5" selected>5 minutes (Standard Break)</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="20">20 minutes</option>
                            <option value="30">30 minutes</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <p><strong>Estimated completion time:</strong> <span id="estimated-completion-time"></span></p>
                        <p class="text-muted small">This goal is set to take <span id="estimated-pomodoro-count">1</span> Pomodoro sessions.</p>
                    </div>

                    <button type="submit" class="btn btn-success w-100">Start Pomodoro Timer</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Delete Your Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h5 class="alert-heading">Warning: This action cannot be undone!</h5>
                    <p>Deleting your account will permanently remove:</p>
                    <ul>
                        <li>All your goals and task records</li>
                        <li>All your Pomodoro session history</li>
                        <li>All your productivity analytics data</li>
                        <li>Your user profile and account information</li>
                    </ul>
                </div>
                <p>Are you absolutely sure you want to delete your account?</p>
                <p>Please type "<strong>DELETE</strong>" to confirm:</p>
                <input type="text" id="delete-confirmation" class="form-control" placeholder="Type DELETE to confirm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteAccountForm" action="/auth/deleteAccount?_method=DELETE" method="POST">
                    <button type="submit" class="btn btn-danger" id="confirm-delete-btn" disabled>Delete My Account</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const confirmInput = document.getElementById('delete-confirmation');
        const confirmButton = document.getElementById('confirm-delete-btn');

        if (confirmInput && confirmButton) {
            confirmInput.addEventListener('input', function() {
                confirmButton.disabled = confirmInput.value !== 'DELETE';
            });
        }
    });
</script>
<script>
    // Create a hidden div element to store goals data
    const goalsDataDiv = document.createElement('div');
    goalsDataDiv.id = 'goals-data';
    goalsDataDiv.style.display = 'none';
    document.body.appendChild(goalsDataDiv);

    // Wait for the DOM content to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Safely get goals data
        const goals = <%- JSON.stringify(goals || []) %>;

        // Define chart variables
        let pendingCount = 0;
        let completedCount = 0;

        // Only calculate if goals exist and have items
        if (goals && goals.length > 0) {
            // Count goals by status
            for (let i = 0; i < goals.length; i++) {
                if (goals[i].status === 'Pending') {
                    pendingCount++;
                } else if (goals[i].status === 'Completed') {
                    completedCount++;
                }
            }
        }

        // Create chart data object
        const statusCounts = {
            'Pending': pendingCount,
            'Completed': completedCount
        };

        // Check if we have any data to display
        const hasData = Object.values(statusCounts).some(value => value > 0);

        // Initialize chart
        const ctx = document.getElementById('goalStatusChart').getContext('2d');
        if (hasData) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#6c757d', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Display a placeholder chart when no data is available
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function() {
                                    return 'No goals available';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to update estimated completion time
        function updateEstimatedCompletionTime() {
            const timerDuration = parseInt(document.getElementById('timer-duration').value) || 25;
            const breakDuration = parseInt(document.getElementById('break-duration').value) || 5;
            const estimatedPomodoros = parseInt(document.getElementById('timer-estimated-pomodoros').value) || 1;

            // Calculate total minutes
            const totalWorkMinutes = timerDuration * estimatedPomodoros;
            const totalBreakMinutes = breakDuration * (estimatedPomodoros - 1); // One less break than pomodoros
            const totalMinutes = totalWorkMinutes + totalBreakMinutes;

            // Format as hours and minutes
            let timeDisplay = '';
            if (totalMinutes >= 60) {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                timeDisplay = `${hours}h ${minutes > 0 ? minutes + 'm' : ''}`;
            } else {
                timeDisplay = `${totalMinutes}m`;
            }

            document.getElementById('estimated-completion-time').textContent = timeDisplay;
            document.getElementById('estimated-pomodoro-count').textContent = estimatedPomodoros;
        }

        // Edit Goal Modal
        const editButtons = document.querySelectorAll('.edit-goal');
        if (editButtons.length > 0) {
            editButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const title = this.getAttribute('data-title');
                    const description = this.getAttribute('data-description') || '';
                    const category = this.getAttribute('data-category') || '';
                    const priority = this.getAttribute('data-priority');
                    const status = this.getAttribute('data-status');
                    const deadline = this.getAttribute('data-deadline') || '';
                    const estimatedPomodoros = this.getAttribute('data-estimated-pomodoros') || '1';

                    // Fill form with data
                    document.getElementById('edit-goal-id').value = id;
                    document.getElementById('edit-title').value = title;
                    document.getElementById('edit-description').value = description;

                    // Set the correct category in the dropdown
                    const categorySelect = document.getElementById('edit-category');
                    for (let i = 0; i < categorySelect.options.length; i++) {
                        if (categorySelect.options[i].value === category) {
                            categorySelect.selectedIndex = i;
                            break;
                        }
                    }

                    document.getElementById('edit-priority').value = priority;
                    document.getElementById('edit-status').value = status;
                    document.getElementById('edit-deadline').value = deadline;
                    document.getElementById('edit-estimated_pomodoros').value = estimatedPomodoros;

                    // Set form action
                    const form = document.getElementById('editGoalForm');
                    form.action = `/goals/${id}?_method=PUT`;

                    // Show modal using Bootstrap's Modal API
                    const editModal = new bootstrap.Modal(document.getElementById('editGoalModal'));
                    editModal.show();
                });
            });
        }

        // Delete Goal Modal
        const deleteButtons = document.querySelectorAll('.delete-goal');
        if (deleteButtons.length > 0) {
            deleteButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');

                    // Set form action
                    const form = document.getElementById('deleteGoalForm');
                    form.action = `/goals/${id}?_method=DELETE`;

                    // Show modal using Bootstrap's Modal API
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteGoalModal'));
                    deleteModal.show();
                });
            });
        }

        // Start Timer Modal
        const startTimerButtons = document.querySelectorAll('.start-timer-btn');
        if (startTimerButtons.length > 0) {
            startTimerButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const title = this.getAttribute('data-title');
                    const estimatedPomodoros = this.getAttribute('data-estimated-pomodoros') || '1';

                    // Fill modal with data
                    document.getElementById('timer-goal-id').value = id;
                    document.getElementById('timer-goal-title').textContent = title;
                    document.getElementById('timer-estimated-pomodoros').value = estimatedPomodoros;

                    // Update estimated completion time
                    updateEstimatedCompletionTime();

                    // Show modal using Bootstrap's Modal API
                    const timerModal = new bootstrap.Modal(document.getElementById('startTimerModal'));
                    timerModal.show();
                });
            });
        }

        // Add event listeners to update estimated completion time when durations change
        document.getElementById('timer-duration').addEventListener('change', updateEstimatedCompletionTime);
        document.getElementById('break-duration').addEventListener('change', updateEstimatedCompletionTime);
    });
</script>

<%- include('partials/footer') %>